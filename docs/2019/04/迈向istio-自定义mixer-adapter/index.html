<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.55.0-DEV with theme Tranquilpeak 0.4.3-SNAPSHOT">
<meta name="author" content="苏连云">
<meta name="keywords" content="istio">
<meta name="description" content="本节我们将自定义一个adapter,adapter和mixer通信使用grpc,所以本节需要对grpc和mixer的adapter有一定的了解.

基于的环境:


istio 1.0.4
golang 1.11(go module)
goland (或者其他go IDE)
">


<meta property="og:description" content="本节我们将自定义一个adapter,adapter和mixer通信使用grpc,所以本节需要对grpc和mixer的adapter有一定的了解.

基于的环境:


istio 1.0.4
golang 1.11(go module)
goland (或者其他go IDE)
">
<meta property="og:type" content="article">
<meta property="og:title" content="迈向istio-自定义mixer adapter">
<meta name="twitter:title" content="迈向istio-自定义mixer adapter">
<meta property="og:url" content="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E8%87%AA%E5%AE%9A%E4%B9%89mixer-adapter/">
<meta property="twitter:url" content="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E8%87%AA%E5%AE%9A%E4%B9%89mixer-adapter/">
<meta property="og:site_name" content="苏连云的博客">
<meta property="og:description" content="本节我们将自定义一个adapter,adapter和mixer通信使用grpc,所以本节需要对grpc和mixer的adapter有一定的了解.

基于的环境:


istio 1.0.4
golang 1.11(go module)
goland (或者其他go IDE)
">
<meta name="twitter:description" content="本节我们将自定义一个adapter,adapter和mixer通信使用grpc,所以本节需要对grpc和mixer的adapter有一定的了解.

基于的环境:


istio 1.0.4
golang 1.11(go module)
goland (或者其他go IDE)
">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2019-04-01T14:15:59">
  
  
    <meta property="article:modified_time" content="2019-04-01T14:15:59">
  
  
  
    
      <meta property="article:section" content="istio">
    
  
  
    
      <meta property="article:tag" content="istio">
    
  


<meta name="twitter:card" content="summary">











  <meta property="og:image" content="https://www.gravatar.com/avatar/a3d740bc2618da5f5a9de4fe94c05429?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/a3d740bc2618da5f5a9de4fe94c05429?s=640">


    <title>迈向istio-自定义mixer adapter</title>

    <link rel="icon" href="https://tangxusc.github.io/blog/favicon.png">
    

    

    <link rel="canonical" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E8%87%AA%E5%AE%9A%E4%B9%89mixer-adapter/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://tangxusc.github.io/blog/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://tangxusc.github.io/blog/">苏连云的博客</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://tangxusc.github.io/blog/#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/a3d740bc2618da5f5a9de4fe94c05429?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://tangxusc.github.io/blog/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/a3d740bc2618da5f5a9de4fe94c05429?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">苏连云</h4>
        
          <h5 class="sidebar-profile-bio">酒剑仙,醉仙酒</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://tangxusc.github.io/blog/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://tangxusc.github.io/blog/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://tangxusc.github.io/blog/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://tangxusc.github.io/blog/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://tangxusc.github.io/blog/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/tangxusc/blog" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      迈向istio-自定义mixer adapter
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2019-04-01T14:15:59&#43;08:00">
        
  April 1, 2019

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://tangxusc.github.io/blog/categories/istio">istio</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>本节我们将自定义一个adapter,adapter和mixer通信使用grpc,所以本节需要对grpc和mixer的adapter有一定的了解.</p>

<p>基于的环境:</p>

<ul>
<li>istio 1.0.4</li>
<li>golang 1.11(go module)</li>
<li>goland (或者其他go IDE)</li>
</ul>

<h2 id="mixer介绍">mixer介绍</h2>

<p>mixer是istio负责<code>策略</code>和<code>遥测</code>的组件,实际上是一个抽象的基础设施后端,用于实现访问控制,遥测捕获,配额管理,计费等功能.</p>

<p>在mixer中提供了adapter的机制用来扩展mixer功能,sidecar在每次请求前调用mixer进行<code>check</code>,在请求完成后向mixer进行<code>report</code>,具体来说mixer提供了:</p>

<ul>
<li>后端adapter的抽象: mixer抽象了后端adapter的实现,sidecar只需要和mixer交互,不再依赖具体的adapter</li>
<li>关注点分离: mixer提供的<code>check</code>,<code>report</code>机制让adapter只需要关注具体的行为,进行细粒度的控制</li>
</ul>

<p>具体的策略和遥测收集如下图所示:</p>

<p><img src="https://istio.io/docs/concepts/policies-and-telemetry/topology-without-cache.svg" alt="" /></p>

<h2 id="adapter介绍">adapter介绍</h2>

<p>adapter是用来扩展mixer行为的组件,mixer和adapter之间使用grpc通信,adapter可以实现日志记录,监控,配额检查,权限检查等,adapter需要向mixer注册,注册后,使用<code>handler/instance/rule</code>进行绑定才能生效.</p>

<p>在mixer中提供了两种类型的adapter实现方式:</p>

<ul>
<li><code>mixer内部的adapter</code>: 放在mixer组件内部,并且编译在mixer中,随着mixer一起发行</li>
</ul>

<p>优点:不用进行grpc网络通信,速度快</p>

<p>缺点:在mixer内部,无法自定义,如果自定义那么需要求改mixer源码重新编译</p>

<ul>
<li><code>外部的adapter</code>: 在k8s集群中以工作负载的方式运行</li>
</ul>

<p>优点:可自定义,并且以工作负载等方式运行部署方便,编译简单</p>

<p>缺点:grpc网络通信,不过grpc通信是可以复用的(http2)</p>

<p>本节我们就要自定义一个外部的adapter来扩展mixer (不实现具体功能,具体功能各位可自行实现,较为简单)</p>

<h2 id="attributes介绍">attributes介绍</h2>

<p>在扩展上有mixer和adapter配合进行扩展,在通信协议上使用grpc,那么具体的通信内容是什么呢?</p>

<p>在mixer中有一个重要的概念是<code>attribute</code>,用于描述请求的所有环境和变量等等,属性的示例如下:</p>

<pre><code class="language-yaml">request.path: xyz/abc
request.size: 234
request.time: 12:34:56.789 04/17/2017
source.ip: 192.168.0.1
destination.service: example
</code></pre>

<p>mixer的本质实际上就是一个属性的处理器,将基础的属性处理后(处理方式参照),发起到具体adapter的grpc调用.</p>

<p>支持的属性可以通过命令k8s命令查看</p>

<pre><code class="language-shell">kubectl get attributemanifests -o yaml -n istio-system
</code></pre>

<p>在使用基础属性时,肯定会有很多属性不满足具体的使用需求,这个时候需要使用到属性表达式来做一些简单的属性编辑,具体示例如下:</p>

<pre><code class="language-yaml">source_name: source.name | &quot;&quot;
source_namespace: source.namespace | &quot;&quot;
destination_name: destination.name | &quot;&quot;
destination_namespace: destination.namespace | &quot;&quot;
source_workload_name: source.workload.name | &quot;&quot;
source_workload_namespace: source.workload.namespace | &quot;&quot;
destination_workload_name: destination.workload.name | &quot;&quot;
destination_workload_namespace: destination.workload.namespace | &quot;&quot;
destination_service_host: destination.service.host | &quot;&quot;
</code></pre>

<h2 id="rule-handler-instance"><code>rule</code>/<code>handler</code>/<code>instance</code></h2>

<p>在这里我们再来回顾一下这三个对象(很重要,很容易错)</p>

<h3 id="handler">handler</h3>

<blockquote>
<p>适配器封装了 Mixer 和特定外部基础设施后端进行交互的必要接口，例如 <a href="https://prometheus.io/">Prometheus</a> 或者 <a href="https://cloud.google.com/logging">Stackdriver</a>。各种适配器都需要参数配置才能工作。例如日志适配器可能需要 IP 地址和端口来进行日志的输出。</p>
</blockquote>

<p>说白了,handler也就是一个具体的adapter实例绑定对象,通过此服务对接各种的后端.</p>

<h3 id="instance">instance</h3>

<blockquote>
<p>配置实例将请求中的属性映射成为适配器的输入。</p>
</blockquote>

<p>在isito中,mixer将请求的所有信息都看做属性,那么属性和hander输入参数之间的映射关系,则由instance维护</p>

<h3 id="rule">rule</h3>

<blockquote>
<p>规则用于指定使用特定实例配置调用某一 Handler 的时机。</p>
</blockquote>

<p>规则就是用于告诉istio,什么时候,什么条件下,调用那个instance完成参数转换,然后输入到handler中.</p>

<h2 id="自定义adapter">自定义adapter</h2>

<p>在了解了这些机制和对象之后,我们开始来一步一步(真一步一步)自定义我们的adapter,此adapter特性:</p>

<ul>
<li>支持<code>authorization</code> template</li>
<li>每个请求到adapter后,都会以json方式打印所附带的信息</li>
<li>adapter的实现作为一个Deployment运行</li>
<li>adapter没有进行复杂的实现,只是打印(各位可自行实现,较为简单)</li>
<li>使用go 1.11的go module模式管理依赖</li>
<li>使用mixc 进行测试</li>
</ul>

<h3 id="准备">准备</h3>

<ol>
<li><p>克隆istio源代码(必须要克隆啊,没得办法,工具在里面)</p>

<pre><code class="language-shell">$ mkdir -p $GOPATH/src/istio.io/ &amp;&amp; cd $GOPATH/src/istio.io/  &amp;&amp; git clone https://github.com/istio/istio
</code></pre></li>

<li><p>安装protoc,并安装grpc插件</p></li>
</ol>

<p>安装方式: <a href="https://gitee.com/tanx/kubernetes-test/blob/master/go/grpc/gomod%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85grpc.md">grpc安装</a></p>

<ol>
<li><p>编译mixs/mixc</p>

<pre><code class="language-shell">cd $GOPATH/src/istio.io/istio/ &amp;&amp; make mixs &amp;&amp; make mixc
</code></pre></li>

<li><p>安装 k8s</p></li>
</ol>

<p><a href="https://gitee.com/tanx/kubernetes-test/blob/master/kubeadm/kubeadm%E5%AE%89%E8%A3%85HA%E9%9B%86%E7%BE%A4.md">使用kubeadm安装ha集群</a></p>

<ol>
<li>安装 istio</li>
</ol>

<p><a href="https://gitee.com/tanx/kubernetes-test/blob/master/%E8%BF%88%E5%90%91istio/README.md">使用helm template 方式安装istio1.04</a></p>

<h3 id="初始化项目">初始化项目</h3>

<p>在任意目录(非$gopath包含)创建项目目录,例如:</p>

<pre><code class="language-shell">cd ~/openProject/ &amp;&amp; mkdir istio-my-adapter
#使用go mod初始化项目
$ go mod init
</code></pre>

<h3 id="编辑依赖">编辑依赖</h3>

<p><code>go.mod</code></p>

<pre><code class="language-shell">module istio-my-adapter

replace (
	golang.org/x/net v0.0.0-20181106065722-10aee1819953 =&gt; github.com/golang/net v0.0.0-20181106065722-10aee1819953
	golang.org/x/sys v0.0.0-20181206074257-70b957f3b65e =&gt; github.com/golang/sys v0.0.0-20181206074257-70b957f3b65e
	golang.org/x/text v0.3.0 =&gt; github.com/golang/text v0.3.0
	golang.org/x/tools v0.0.0-20180221164845-07fd8470d635 =&gt; github.com/golang/tools v0.0.0-20180221164845-07fd8470d635
	golang.org/x/tools v0.0.0-20180828015842-6cd1fcedba52 =&gt; github.com/golang/tools v0.0.0-20180828015842-6cd1fcedba52
	google.golang.org/genproto v0.0.0-20190201180003-4b09977fb922 =&gt; github.com/google/go-genproto v0.0.0-20190201180003-4b09977fb922
	google.golang.org/grpc v1.16.0 =&gt; github.com/grpc/grpc-go v1.16.0
)

require (
	github.com/BurntSushi/toml v0.3.1 // indirect
	github.com/gogo/googleapis v1.1.0 // indirect
	github.com/gogo/protobuf v1.2.1
	github.com/hashicorp/go-multierror v1.0.0 // indirect
	github.com/inconshreveable/mousetrap v1.0.0 // indirect
	github.com/natefinch/lumberjack v2.0.0+incompatible // indirect
	github.com/pkg/errors v0.8.1 // indirect
	github.com/spf13/cobra v0.0.3 // indirect
	github.com/spf13/pflag v1.0.3 // indirect
	github.com/stretchr/testify v1.3.0 // indirect
	go.uber.org/atomic v1.3.2 // indirect
	go.uber.org/multierr v1.1.0 // indirect
	go.uber.org/zap v1.9.1 // indirect
	golang.org/x/net v0.0.0-20181106065722-10aee1819953
	golang.org/x/sys v0.0.0-20181206074257-70b957f3b65e // indirect
	google.golang.org/genproto v0.0.0-20190201180003-4b09977fb922 // indirect
	google.golang.org/grpc v1.16.0
	gopkg.in/natefinch/lumberjack.v2 v2.0.0 // indirect
	gopkg.in/yaml.v2 v2.2.2 // indirect
	istio.io/api v0.0.0-20190215181734-2b2fabd45153
	istio.io/istio v0.0.0-20190216013735-f62b4fa7d7ad
)
</code></pre>

<p>编辑好依赖后,在shell运行</p>

<pre><code class="language-shell">$ go mod tidy
</code></pre>

<p>其实这里做了两件事</p>

<p>1,require 引入adapter需要的依赖</p>

<p>2,replace 替换无法获取的代码库为github中的地址</p>

<p>在这里将adapter的依赖和需要替换的包全部编辑好,以免后面引入包失败.</p>

<p>如果对go module 了解的较少,可以参考: <a href="https://gitee.com/tanx/kubernetes-test/blob/master/go/%E5%82%BB%E7%93%9C%E5%BC%8F%E7%9A%84%20go%20modules%20%E7%9A%84%E8%AE%B2%E8%A7%A3%E5%92%8C%E4%BB%A3%E7%A0%81.md"><strong>傻瓜式的 go modules 的讲解和代码.md</strong></a> , <a href="https://gitee.com/tanx/kubernetes-test/blob/master/go/Go%E6%A8%A1%E5%9D%97%E7%AE%80%E4%BB%8B.md"><strong>Go模块简介.md</strong></a></p>

<h3 id="创建my-go">创建my.go</h3>

<pre><code class="language-shell">$ mkdir adapter
</code></pre>

<p>在<code>adapter</code>文件夹中创建my.go文件,文件内容如下:</p>

<pre><code class="language-go">package adapter

import (
	&quot;golang.org/x/net/context&quot;
	&quot;istio.io/istio/mixer/template/authorization&quot;
)

var _ authorization.HandleAuthorizationServiceServer = &amp;MyAuth{}

type MyAuth struct {
}
</code></pre>

<p><code>authorization.HandleAuthorizationServiceServer</code>接口则是我们需要实现的Authorization接口</p>

<p>这里可能很多人都会疑问,这个接口在哪里找,其他的template提供的接口怎么去找.</p>

<p>其实这里很简单,在mixer的源代码中就有proto描述,例如Authorization:</p>

<pre><code class="language-shell">$ cd $GOPATH/src/istio.io/istio/mixer/template &amp;&amp; tree
.
├── apikey
│   ├── apiKey.pb.html
│   ├── template_handler.gen.go
│   ├── template_handler_service.descriptor_set
│   ├── template_handler_service.pb.go
│   ├── template_handler_service.proto				#这个就是声明文件
│   ├── template.proto
│   ├── template_proto.descriptor_set
│   └── template.yaml
├── authorization
│   ├── authorization.pb.html
│   ├── template_handler.gen.go
│   ├── template_handler_service.descriptor_set
│   ├── template_handler_service.pb.go
│   ├── template_handler_service.proto				#这个就是声明文件
│   ├── template.proto
│   ├── template_proto.descriptor_set
│   └── template.yaml
├── checknothing
│   ├── checkNothing.pb.html
│   ├── template_handler.gen.go
│   ├── template_handler_service.descriptor_set
│   ├── template_handler_service.pb.go
│   ├── template_handler_service.proto
│   ├── template.proto
│   ├── template_proto.descriptor_set
│   └── template.yaml
...
</code></pre>

<p>打开<code>template_handler_service.proto</code>就可以看到</p>

<pre><code class="language-protobuf">package authorization;

#省略n个字符
// HandleAuthorizationService is implemented by backends that wants to handle request-time 'authorization' instances.
service HandleAuthorizationService {
    // HandleAuthorization is called by Mixer at request-time to deliver 'authorization' instances to the backend.
    rpc HandleAuthorization(HandleAuthorizationRequest) returns (istio.mixer.adapter.model.v1beta1.CheckResult);
    
}
#省略n个字符
</code></pre>

<p>通过package的值 和 service的声明就可以直接找到此接口(当然在idea中也可以直接搜索找到此接口)</p>

<p>我们让<code>MyAuth</code>实现此接口,则我们的代码中还需要添加如下代码:</p>

<pre><code class="language-go">package adapter

import (
	&quot;encoding/json&quot;
	&quot;fmt&quot;
	&quot;golang.org/x/net/context&quot;
	&quot;istio.io/api/mixer/adapter/model/v1beta1&quot;
	&quot;istio.io/istio/mixer/pkg/status&quot;
	&quot;istio.io/istio/mixer/template/authorization&quot;
)

var _ authorization.HandleAuthorizationServiceServer = &amp;MyAuth{}

type MyAuth struct {
}

func (*MyAuth) HandleAuthorization(ctx context.Context, request *authorization.HandleAuthorizationRequest) (*v1beta1.CheckResult, error) {
	bytes, e := json.Marshal(request)
	if e != nil {
		fmt.Println(&quot;序列化失败,&quot;, e.Error())
	}
	fmt.Printf(&quot;%s \n&quot;, string(bytes))
	return &amp;v1beta1.CheckResult{
		Status: status.OK,
	}, nil
}

</code></pre>

<blockquote>
<p>这里我写详细一些,可以让各位少走很多弯路.</p>
</blockquote>

<p>根据以上代码,我们的adapter其实什么事情都没有干,只是将 request 序列化为json 然后打印了出来, 然后回复了一个Status为OK的请求,各位可以基于此方法定制自己的逻辑,但是在此处,我将以最简单的方式来做.</p>

<h3 id="创建adapter启动文件">创建adapter启动文件</h3>

<p>adapter的处理已经创建好了,那么接下来我们就启动这个grpc的server就好了.</p>

<p>在项目根目录创建main.go</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;google.golang.org/grpc&quot;
	&quot;istio-my-adapter/adapter&quot;
	&quot;istio.io/istio/mixer/template/authorization&quot;
	&quot;net&quot;
)

func main() {
    //创建grpc服务器
	server := grpc.NewServer()
	auth := &amp;adapter.MyAuth{}
    //注册服务到grpc
	authorization.RegisterHandleAuthorizationServiceServer(server, auth)
    //启动9999端口监听tcp数据
	listener, e := net.Listen(&quot;tcp&quot;, fmt.Sprintf(&quot;:%s&quot;, &quot;9999&quot;))
	if e != nil {
		println(&quot;tcp监听错误,&quot;, e.Error())
	}
    //启动
	if e := server.Serve(listener); e != nil {
		fmt.Println(&quot;grpc启动错误,&quot;, e.Error())
	}
}

</code></pre>

<p>是不是贼简单.</p>

<h3 id="创建check数据文件">创建check数据文件</h3>

<p>在项目根目录创建一个config目录(因为istio官方的mixer教程是创建config),并在其中定义通信数据</p>

<pre><code class="language-shell">mkdir config
</code></pre>

<p><code>my.proto</code></p>

<pre><code class="language-proto">syntax = &quot;proto3&quot;;

// config for my-adapter
package adapter.my.config;

import &quot;gogoproto/gogo.proto&quot;;

option go_package = &quot;config&quot;;

// config for myadapter
// 这里是对应handler中的字段
message Params {
    // Path of the file to save the information about runtime requests.
    //这里是在handler上启动填写的参数
    string file_path = 1;
}
</code></pre>

<p>写好了proto文件后,我们就可以使用protoc生成我们需要的源代码啦</p>

<h3 id="protoc生成文件">protoc生成文件</h3>

<p>在开始生成文件前,国内用户一定要做一个准备工作,因为mixer_codegen.sh文件依赖一个<code>gcr.io/istio-testing/protoc</code> docker image,所以你需要先拉取下来</p>

<pre><code class="language-shell">$ docker pull tangxusc/istio-protoc-mirror:latest
$ docker tag tangxusc/istio-protoc-mirror:latest gcr.io/istio-testing/protoc:2018-06-12
</code></pre>

<p>拉取完成镜像后,麻烦又来了,mixer_codegen.sh 传入的 路径是相对于$GOPATH的,所以这里有两个方式:</p>

<p>1,做个连接(link),把项目的config目录连接到$GOPATH下的某个地方</p>

<p>2,把proto拷贝过去</p>

<blockquote>
<p>如果有更好的方式,请一定告诉我</p>
</blockquote>

<p>为了简单,这里我们直接使用第二种</p>

<pre><code class="language-shell">$ cp config/*.proto $GOPATH/src/istio.io/istio/myadapter/
</code></pre>

<p>然后使用protoc开始生成源代码和adapter描述文件</p>

<pre><code class="language-shell">$ sh $GOPATH/src/istio.io/istio/bin/mixer_codegen.sh -a myadapter/my.proto -x &quot;-s=false -n myadapter -t authorization&quot;
</code></pre>

<p>或者在my.go中直接写:</p>

<pre><code class="language-go">//go:generate $GOPATH/src/istio.io/istio/bin/mixer_codegen.sh -a myadapter/my.proto -x &quot;-s=false -n myadapter -t authorization&quot;

package adapter
...
</code></pre>

<p>然后运行</p>

<pre><code class="language-shell">go generate ./...
</code></pre>

<p>重要参数释义:</p>

<p>-s :<code>true</code> 基于会话模型(尚未实现) <code>false</code> 基于无会话模型</p>

<p>-n : adapter名称</p>

<p>-t : template名称</p>

<p>-a : 输入的文件位置</p>

<p>执行命令后将生成文件如下:</p>

<pre><code class="language-shell">$ pwd &amp;&amp; tree
$GOPATH/src/istio.io/istio/myadapter
.
├── adapter.my.config.pb.html
├── myadapter.yaml
├── my.pb.go
├── my.proto
└── my.proto_descriptor
0 directories, 5 files
</code></pre>

<p>拷贝<code>myadapter.yaml</code>至项目的config目录内</p>

<h3 id="配置handler-instance-rule">配置handler/instance/rule</h3>

<p>这三个都是老朋友了,直接给出配置好的文件<code>istio.yaml</code>如下:</p>

<pre><code class="language-yaml">apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: handler
metadata:
  name: my
  namespace: istio-system
spec:
  adapter: myadapter
  connection:
    address: &quot;my.istio-system:9999&quot;
  params:	#这就是proto中配置的Params
    file_path: &quot;/test/a.txt&quot;
---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: instance
metadata:
  name: my
  namespace: istio-system
spec:
  template: authorization
  params:
    subject:
      properties:
        request_path: request.path | &quot;/&quot;
        source_name: source.name | &quot;&quot;
        source_namespace: source.namespace | &quot;&quot;
        destination_name: destination.name | &quot;&quot;
        destination_namespace: destination.namespace | &quot;&quot;
        source_workload_name: source.workload.name | &quot;&quot;
        source_workload_namespace: source.workload.namespace | &quot;&quot;
        destination_workload_name: destination.workload.name | &quot;&quot;
        destination_workload_namespace: destination.workload.namespace | &quot;&quot;
        destination_service_host: destination.service.host | &quot;&quot;

---
apiVersion: &quot;config.istio.io/v1alpha2&quot;
kind: rule
metadata:
  name: r1
  namespace: istio-system
spec:
  match: &quot;&quot;
  actions:
    - handler: my.handler.istio-system
      instances:
        - my.instance.istio-system
</code></pre>

<h2 id="测试">测试</h2>

<p>在做好以上步骤后,我们可以在我们本地测试一下我们的代码是否正确,mixer的adapter测试有两种方式:</p>

<ul>
<li><p>使用golang代码进行测试 : 在项目中嵌入golang测试文件,并运行golang的单元测试</p></li>

<li><p>使用mixs和mixc进行测 : 启动mixs作为服务端,并监听本地的配置文件,启动mixc作为客户端向mixs发送check等请求,mixs再通过grpc转发到具体的adapter上.</p></li>
</ul>

<p>毫无疑问,第二种更适合真正的istio集群的情况(不是说第一种不好),所以在此我们选择使用mixs和mixc进行测试</p>

<h3 id="准备-1">准备</h3>

<ol>
<li><p>编译mixs和mixc (如果前面已经编译,则此处不用再编译)</p>

<pre><code class="language-shell">cd $GOPATH/src/istio.io/istio/ &amp;&amp; make mixs &amp;&amp; make mixc
</code></pre></li>

<li><p>创建测试文件夹及文件</p>

<pre><code class="language-shell">mkdir 项目根目录/testdata
cp 项目根目录/k8s/istio.yaml 项目根目录/testdata/
cp 项目根目录/config/
cp $GOPATH/src/istio.io/istio/mixer/testdata/config/attributes.yaml 目根目录/testdata/
cp $GOPATH/src/istio.io/istio/mixer/template/authorization/template.yaml 目根目录/testdata/
</code></pre></li>
</ol>

<p>拷贝完成后目录是这样的:</p>

<pre><code class="language-shell">   /testdata$ tree
   ├── attributes.yaml
   ├── istio.yaml
   ├── myadapter.yaml
   └── template.yaml
   0 directories, 4 files
</code></pre>

<ol>
<li><p>启动adapter</p>

<pre><code class="language-shell">$ go run main.go
</code></pre></li>
</ol>

<p>在此,我们启动了grpc服务器,并暴露在<code>9999</code>端口上</p>

<ol>
<li><p>启动mixs</p>

<pre><code class="language-shell">./mixs server --configStoreURL=fs:///项目路径/istio-my-adapter/testdata/ --log_output_level=attributes:debug
</code></pre></li>
</ol>

<blockquote>
<p>注意: 如果出现未找到mixs等错误,请配置你的Path,<code>$GOPATH/out/linux_amd64/release/</code>必须包含在path中,才能找到mixs和mixc的执行文件</p>

<p>注意: <code>fs://</code> 标示文件系统,后面是文件系统的路径,所以才会出现三个<code>/</code></p>
</blockquote>

<ol>
<li><p>启动mixc</p>

<pre><code class="language-shell">./mixc check -s destination.service=&quot;svc.cluster.local&quot; -s request.path=&quot;/test222&quot;
</code></pre></li>

<li><p>在执行了以上命令后就可以在控制台和adapter上均可以看到结果了</p></li>
</ol>

<h2 id="部署准备">部署准备</h2>

<h3 id="生成adapter镜像">生成adapter镜像</h3>

<p>当我们确认好了我们的adapter工作正常后,adapter要以容器的方式来运行,所以我们需要编写Dockerfile,并生成为镜像:</p>

<p><code>Dockerfile</code> 如下:</p>

<pre><code class="language-dockerfile"># docker build -t my-adapter:2 .
FROM ubuntu
WORKDIR /
ADD main /main
EXPOSE 9999
CMD [&quot;./main&quot;]
</code></pre>

<pre><code class="language-shell">$ go build main.go
$ docker build -t my-adapter:2 .
</code></pre>

<h3 id="配置adapter工作负载">配置adapter工作负载</h3>

<p>adapter需要以工作负载的方式运行在k8s中,所以在此处,我们需要配置工作负载文件<code>k8s.yaml</code>:</p>

<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: my
  namespace: istio-system
  labels:
    app: my
spec:
  replicas: 1
  template:
    metadata:
      name: my
      labels:
        app: my
    spec:
      containers:
        - name: my
          image: my-adapter:2
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9999
              protocol: TCP
      restartPolicy: Always
  selector:
    matchLabels:
      app: my
---
apiVersion: v1
kind: Service
metadata:
  name: my
  namespace: istio-system
spec:
  selector:
    app: my
  ports:
  - port: 9999
    targetPort: 9999
    protocol: TCP
</code></pre>

<p>一切就绪后,我们就可以部署到我们的istio集群中进行验证了.</p>

<h2 id="部署">部署</h2>

<h3 id="部署测试服务">部署测试服务</h3>

<p>​   测试服务部署: <a href="https://gitee.com/tanx/kubernetes-test/tree/master/%E8%BF%88%E5%90%91istio/1-istio-%E7%A4%BA%E4%BE%8B">nginx服务</a></p>

<h3 id="部署adapter">部署adapter</h3>

<pre><code class="language-shell">kubectl apply -f istio.yaml
kubectl apply -f k8s.yaml
kubectl apply -f myadapter.yaml
</code></pre>

<p>现在使用curl访问istio集群中的任意服务,在Deployment中的容器将会打印如下信息:</p>

<pre><code class="language-json">&quot;instance&quot;:{&quot;name&quot;:&quot;my.instance.istio-system&quot;,&quot;subject&quot;:{&quot;properties&quot;:{&quot;request_path&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;/test&quot;}},&quot;destination_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;unknown&quot;}},&quot;destination_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;default&quot;}},&quot;destination_service_host&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;nginx.test.svc.cluster.local&quot;}},&quot;destination_workload_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;unknown&quot;}},&quot;destination_workload_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;unknown&quot;}},&quot;source_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-ingressgateway-6fc88db97f-98qs8&quot;}},&quot;source_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-system&quot;}},&quot;source_workload_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-ingressgateway&quot;}},&quot;source_workload_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-system&quot;}}}}},&quot;adapter_config&quot;:{&quot;type_url&quot;:&quot;type.googleapis.com/adapter.my.config.Params&quot;,&quot;value&quot;:&quot;CgsvdGVzdC9hLnR4dA==&quot;},&quot;dedup_id&quot;:&quot;11419436721688692556&quot;}

{&quot;instance&quot;:{&quot;name&quot;:&quot;my.instance.istio-system&quot;,&quot;subject&quot;:{&quot;properties&quot;:{&quot;request_path&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;/&quot;}},&quot;destination_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;nginx-69d9d7887c-rtnbh&quot;}},&quot;destination_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;test&quot;}},&quot;destination_service_host&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;&quot;}},&quot;destination_workload_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;nginx&quot;}},&quot;destination_workload_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;test&quot;}},&quot;source_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-ingressgateway-6fc88db97f-98qs8&quot;}},&quot;source_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-system&quot;}},&quot;source_workload_name&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-ingressgateway&quot;}},&quot;source_workload_namespace&quot;:{&quot;Value&quot;:{&quot;StringValue&quot;:&quot;istio-system&quot;}}}}},&quot;adapter_config&quot;:{&quot;type_url&quot;:&quot;type.googleapis.com/adapter.my.config.Params&quot;,&quot;value&quot;:&quot;CgsvdGVzdC9hLnR4dA==&quot;},&quot;dedup_id&quot;:&quot;11419436721688692557&quot;}
</code></pre>

<p>到此,自定义adapter完成.</p>

<h2 id="总结">总结</h2>

<p>整体来说,自定义一个adapter还是需要依赖不少的知识的.</p>

<ul>
<li>在通信上需要各位对grpc有一定的了解</li>
<li>在整体交互上需要各位了解mixer的一些设计,并且知道sidecar的交互过程</li>
<li>在编译istio的过程中可能会出现一些包无法获取到,需要翻墙的情况,这就只能手动去做了</li>
<li>在配置handler等声明时,很容易出现各种错误,这就需要一点一点的查日志找原因了</li>
<li>本示例本身以简单为主,并没有真正的功能,但是各位在此基础上拓展应该较为容易</li>
<li>写好adapter代码后不建议直接放到集群中进行测试需要进一步验证后再进行测试,这样方便确定问题所在</li>
</ul>

<h2 id="参照">参照</h2>

<p><a href="https://github.com/istio/istio/wiki/Mixer-Out-Of-Process-Adapter-Dev-Guide">Mixer Out Of Process Adapter Dev Guide</a></p>

<p><a href="https://github.com/istio/istio/wiki/Mixer-Out-Of-Process-Adapter-Walkthrough#step-4-write-sample-operator-config">Mixer Out of Process Adapter Walkthrough</a></p>

<p><a href="https://istio.io/docs/concepts/policies-and-telemetry/">Policies and Telemetry</a></p>

<p><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDIzODExOA==&amp;mid=2650166632&amp;idx=1&amp;sn=2417079d18383a399f7dac23a85b3e69&amp;chksm=8ec1c921b9b64037651a7970401cd973eb11718a81d8f2fbc10bba9f190d7e736142c635e210&amp;mpshare=1&amp;scene=1&amp;srcid=#rd">通过自定义Istio Mixer Adapter在JWT场景下实现用户封禁</a></p>

<p><a href="https://github.com/istio/istio/tree/master/mixer/template">mixer template</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://tangxusc.github.io/blog/tags/istio/">istio</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E7%BD%91%E5%85%B3/" data-tooltip="迈向istio-网关">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E6%B8%85%E5%8D%95/" data-tooltip="迈向istio-错误排查清单">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 苏连云. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E7%BD%91%E5%85%B3/" data-tooltip="迈向istio-网关">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E6%B8%85%E5%8D%95/" data-tooltip="迈向istio-错误排查清单">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/a3d740bc2618da5f5a9de4fe94c05429?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">苏连云</h4>
    
      <div id="about-card-bio">酒剑仙,醉仙酒</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        小农民
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        chengdu
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-11-%E5%8D%87%E7%BA%A7%E5%88%B01.1.2/">
                <h3 class="media-heading">迈向istio-11 升级到1.1.2</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>istio经过8个月的发展和社区中的各位大佬的孜孜不倦的贡献,终于发布了1.1版本,新版本为<code>企业级就绪</code></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-jwt%E8%AE%A4%E8%AF%81/">
                <h3 class="media-heading">迈向istio-jwt认证</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在建设企业的各种项目中,我们一定离不开,或者总要和认证授权系统打交道,应用总会入侵一些认证和授权部分的代码,现在在java等方面有大量的安全框架,例如<code>spring security,shiro</code>等等框架,这些框架也是为了解决这个重复性的做认证和授权等功能的问题,这也是我们在单体服务的时候一直做的,将各种各样的框架集成到系统中,那么现在在微服务时代,或者说在istio有没有解决方法能解决这个问题呢,让服务真正回归业务,不再去过多的管理认证的问题呢.</p>

<p>在本节中我们将会将我们的应用构建为一个需要使用jwt token才能访问的服务,在没有jwt token的情况下,将会返回401 未授权.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-opa%E6%8E%88%E6%9D%83/">
                <h3 class="media-heading">迈向istio-opa授权</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在上一章节中,我们使用jwt进行了认证,那么我们如何对资源进行授权检查呢?</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-tls/">
                <h3 class="media-heading">迈向istio-tls</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>我们已经完成了我们服务的路由,并且也已经有了镜像流量了,那么接下来我们要做什么呢?</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E5%A4%9A%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1/">
                <h3 class="media-heading">迈向istio-多服务通信</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在之前的示例中,我们在istio中启动了nginx,tomcat等服务,那在此节中,我们再深入的进行一些功能的使用;</p>

<p>在微服务的背景下,现在越来越多的被拆分为单个服务了,那么这些服务怎么在istio上运行,服务间如何进行通信呢?在本节中我们将尝试构建一个proxy服务和target服务</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E5%AE%89%E8%A3%85/">
                <h3 class="media-heading">迈向istio-安装</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>istio-安装</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1/">
                <h3 class="media-heading">迈向istio-引入外部服务</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在istio中所有的流量都是通过istio的initContainer启动的时候对iptable进行了劫持的,那么外部流量就无法通过dns等服务发现机制进行路由了,这个时候怎么办呢? 这一节我们就来解决这个问题.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E6%9C%8D%E5%8A%A1%E8%B7%AF%E7%94%B1/">
                <h3 class="media-heading">迈向istio-服务路由</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在上一节中,我们使用nginx开启了我们istio的第一个应用,现在我们加入另外一个服务tomcat</p>

<blockquote>
<p>本节内容基于上节内容,请先运行上一节的yaml文件,然后再体验本节内容</p>
</blockquote></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E7%A4%BA%E4%BE%8B/">
                <h3 class="media-heading">迈向istio-示例</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在上一节中我们已经成功的安装了istio的各个组件,接下来我们一起来运行一个nginx,体验一下istio的功能</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tangxusc.github.io/blog/2019/04/%E8%BF%88%E5%90%91istio-%E7%BD%91%E5%85%B3/">
                <h3 class="media-heading">迈向istio-网关</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>在上一节中我们已经成功的简单运行了istio的一个路由,也有了一番流量管理的体验,那么很多人都不禁要问,这些配置和yaml是什么意思呢?</p>

<p>那接下来我们基于istio示例中的配置,一点一点的解析这些yaml文件.</p>

<blockquote>
<p>nginx.yaml中的内容为k8s的yaml文件,再此不做赘述.</p>
</blockquote></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         77 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://tangxusc.github.io/blog/images/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://tangxusc.github.io/blog/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/tangxusc.github.io\/blog\/2019\/04\/%E8%BF%88%E5%90%91istio-%E8%87%AA%E5%AE%9A%E4%B9%89mixer-adapter\/';
          
            this.page.identifier = '\/2019\/04\/%E8%BF%88%E5%90%91istio-%E8%87%AA%E5%AE%9A%E4%B9%89mixer-adapter\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

